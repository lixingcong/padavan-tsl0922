include $(ROOTDIR)/rules.mk

PKG_NAME:=dnsmasq
PKG_VERSION:=2.90

PKG_SOURCE_DATE:=2024-10-05
PKG_SOURCE_PROTO:=git
PKG_SOURCE_URL:=git://thekelleys.org.uk/dnsmasq.git
PKG_SOURCE_VERSION:=d7d682637d1a85947891d10b5b16b99db852aa38

include $(INCLUDE_DIR)/package.mk

COPTS := -DHAVE_BROKEN_RTC -DNO_INOTIFY -DNO_AUTH -DNO_LOOP
ifndef CONFIG_IPV6
COPTS += -DNO_IPV6
endif
ifndef CONFIG_USB_SUPPORT
COPTS += -DNO_TFTP
endif
ifneq ($(CONFIG_FIRMWARE_INCLUDE_IPSET),y)
COPTS += -DNO_IPSET
endif

# regex support
ifeq ($(CONFIG_FIRMWARE_DNSMASQ_REGEX),y)
	COPTS += -DHAVE_REGEX

	ifeq ($(CONFIG_FIRMWARE_INCLUDE_IPSET),y)
		COPTS += -DHAVE_REGEX_IPSET
	endif
endif

MAKE_FLAGS := \
	$(TARGET_CONFIGURE_OPTS) \
	CFLAGS="$(TARGET_CFLAGS)" \
	LDFLAGS="$(TARGET_LDFLAGS)" \
	COPTS="$(COPTS)" \
	CUSTOM_VERSION="$(PKG_VERSION)" \
	PREFIX=

$(eval $(call BuildPackage,dnsmasq))

romfs:
	$(INSTALL_DIR) $(ROMFSDIR)/usr/sbin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/src/dnsmasq $(ROMFSDIR)/usr/sbin/dnsmasq
